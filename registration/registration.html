<!DOCTYPE html>
<html>
<body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>var ip;</script>
<script src="https://l2.io/ip.js?var=ip"></script>
<script>
	var redditValid = false;
	var ffValid = false;
	var emailValid = false;

	// Validate reddit account
	function validateReddit() {
		var reddit_name = document.getElementById("reddit_name").value;
		var url = "https://www.reddit.com/user/" + reddit_name;

		$.ajax({
			url: "verify.php",
			type: "get",
			async: false,
			data: {
				user: reddit_name,
				site: "reddit"
			},
			timeout: 2000,
			success: function(data) {
				if(data == "true") {
					$("#reddit_error").text("");
					$("#reddit_name").css("border", "1px solid #00ff00");
					redditValid = true;
				}
				else {
					$("#reddit_error").text(data);
					$("#reddit_name").css("border", "1px solid #ff0000");
					redditValid = false;
				}
			},
			error: function() {
				alert("Call to verify.php failed.");
				$("#reddit_name").val("");
				$("#reddit_name").css("border", "1px solid #ff0000");
				redditValid = false;
			}
		});
	}

	// Validate fleaflicker account
	function validateFleaflicker() {
		var ff_name = document.getElementById("ff_name").value;
		var url = "http://www.fleaflicker.com/users/" + ff_name;

		var re = /^[0-9]{3,7}$/;
		if(!re.test(ff_name)) {
			$("#ff_error").text("Fleaflicker ID is a 3-7 digit number. It can be found in the URL of your user page.");
			$("#ff_name").css("border", "1px solid #ff0000");
			ffValid = false;
			return;
		}

		$.ajax({
			url: "verify.php",
			type: "get",
			async: false,
			data: {
				user: ff_name,
				site: "fleaflicker"
			},
			timeout: 2000,
			success: function(data) {
				if(data == "true") {
					$("#ff_error").text("");
					$("#ff_name").css("border", "1px solid #00ff00");
					ffValid = true;
				}
				else {
					$("#ff_error").text(data);
					$("#ff_name").css("border", "1px solid #ff0000");
					ffValid = false;
				}
			},
			error: function() {
				alert("Call to verify.php failed.");
				$("#ff_name").val("");
				$("#ff_name").css("bofder", "1px solid #ff0000");
				ffValid = false;
			}
		});
	}

	// Validate email address
	function validateEmail() {
		var email = document.getElementById("email").value;
		var re = /^.*@.*\..*/;
		if(!re.test(email)) {
			$("#email_error").text("Email address format not valid.");
			$("#email").css("border", "1px solid #ff0000");
			emailValid = false;
		}
		else {
			$("#email").css("border", "1px solid #00ff00");
			emailValid = true;
		}
	}

	// Ensure entire form is valid
	function validateForm(evt) {
		var reddit_name = document.getElementById("reddit_name").value;
		var ff_name = document.getElementById("ff_name").value;
		var email = document.getElementById("email").value;

		// Make sure all fields were actually filled out
		if(reddit_name == "" || ff_name == "" || email == "") {
			evt.preventDefault();
			return false;
		}

		$("#hidden").val(ip);

		// Return true if everything else is valid
		return redditValid && ffValid && emailValid;
	}
</script>

<form name="myForm" action="register.php" onsubmit="return validateForm(event)" method="post">
	Reddit Name: <input type="text" id="reddit_name" name="rname" onblur="validateReddit()"><span id="reddit_error" style="color:#ff0000; margin-left:5px"></span><br>
	Fleaflicker ID (found in the URL for your user page): <input type="text" id="ff_name" name="fname" onblur="validateFleaflicker()"><span id="ff_error" style="color:#ff0000; margin-left:5px"></span><br>
	Email: <input type="text" id="email" name="email" onblur="validateEmail()"><span id="email_error" style="color:#ff0000; margin-left:5px"></span><br>
	Returning member?: <input type="checkbox" id="returning" name="returning"><br>
	<input type="hidden" name="ip" id="hidden">
	<input type="submit" value="Register">
</form>

<!--
POST will receive variables:
- rname
- fname
- email
- returning
- ip
-->

</body>
</html>
